generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Policy {
  id          String          @id @default(uuid())
  tenantId    String          @map("tenant_id")
  name        String
  description String?
  isActive    Boolean         @default(true) @map("is_active")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  versions    PolicyVersion[]

  @@index([tenantId])
  @@map("policies")
}

model PolicyVersion {
  id          String       @id @default(uuid())
  policyId    String       @map("policy_id")
  tenantId    String       @map("tenant_id")
  version     Int
  rules       Json         // Stored as structured JSONB
  isCurrent   Boolean      @default(false) @map("is_current")
  createdAt   DateTime     @default(now()) @map("created_at")

  policy      Policy       @relation(fields: [policyId], references: [id])
  snapshots   PolicySnapshot[]

  @@unique([policyId, version])
  @@index([tenantId])
  @@map("policy_versions")
}

model PolicySnapshot {
  id              String        @id @default(uuid())
  policyVersionId String        @map("policy_version_id")
  tenantId        String        @map("tenant_id")
  snapshotData    Json          @map("snapshot_data")
  createdAt       DateTime      @default(now()) @map("created_at")

  policyVersion   PolicyVersion @relation(fields: [policyVersionId], references: [id])

  @@index([tenantId])
  @@map("policy_snapshots")
}

model PolicyAuditLog {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  actorId     String   @map("actor_id")
  action      String
  entityId    String   @map("entity_id")
  entityType  String   @map("entity_type")
  beforeState Json?    @map("before_state")
  afterState  Json?    @map("after_state")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([tenantId])
  @@map("policy_audit_logs")
}
